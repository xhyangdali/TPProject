<extend name="Public:base"/>
<block name="title">数据统计</block>
<block name="content">
    <!-- tab选项卡 start -->
    <div class="weui-tab">
        <div class="weui-navbar" >
            <a class="weui-navbar__item weui-bar__item--on" href="#tab1">
                图表分析
            </a>
            <a id="words_select" class="weui-navbar__item" href="#tab2">
                文字分析
            </a>
        </div>
        <div class="weui-tab__bd" >
            <!-- weui-tab__bd-item start -->
            <div id="tab1" class="weui-tab__bd-item weui-tab__bd-item--active">

                <div class="weui-panel weui-panel_access">
                    <div class="weui-panel__hd"><h3>关区客运站窗口售票金额</h3><label name="lbdate"></label></div>
                    <div class="weui-panel__bd">
                        <canvas id="myChart1" width="400px" height="300px;"></canvas>
                    </div>
                </div>

                <div class="weui-panel weui-panel_access">
                    <div class="weui-panel__hd"><h3>县分公司客运站窗口售票金额</h3><label name="lbdate"></label></div>
                    <div class="weui-panel__bd">
                        <canvas id="myChart2" width="400px" height="300px;"></canvas>
                    </div>
                </div>

                <div class="weui-panel weui-panel_access">
                    <div class="weui-panel__hd"><h3>电子客票销售张数统计</h3><label name="lbdate"></label></div>
                    <div class="weui-panel__bd">
                        <canvas id="myChart3" width="400px" height="300px;"></canvas>
                    </div>
                </div>

                <div class="weui-panel weui-panel_access">
                    <div class="weui-panel__hd"><h3>电子客票销售金额统计</h3><label name="lbdate"></label></div>
                    <div class="weui-panel__bd">
                        <canvas id="myChart4" width="400px" height="300px;"></canvas>
                    </div>
                </div>

            </div>
            <!-- weui-tab__bd-item end -->
            <!-- weui-tab__bd-item start -->
            <div id="tab2" class="weui-tab__bd-item ">
                <!-- page__bd start -->
                <div id="div_wtotal" class="page__bd">
                    <h3>统计概况</h3>
                    <p class="Ctext">窗口售票金额共计：共计销售车票1763张，销售金额：79.13万元</p>
                    <p class="Ctext">电子客票：共计销售车票1763张，销售金额：94,354元。</p>
                    <p class="Ctext">客票保险：保险票255张，销售金额：8,354元。</p>
                </div>
                <!-- page__bd end -->
                <!-- page__bd start -->
                <div class="page__bd">
                    <div class="weui-cells__title"><label name="lbdate"></label></div>
                    <div class="weui-cells">
                        <div class="weui-cell">
                            <div class="weui-cell__bd">
                                <p>窗口售票金额</p>
                            </div>
                            <div id="div_cktotal" class="weui-cell__ft">共计：79.13万元</div>
                        </div>
                        <div class="weui-cell weui-cell_swiped">
                            <div id="words_ck" class="page__bd">
                                <p class="Ctext">东部客运站：10.58万元</p>
                                <p class="Ctext">快速客运站：11.23万元</p>
                                <p class="Ctext">兴盛客运站：11.96万元</p>
                                <p class="Ctext">客运北站：10.36万元</p>
                                <p class="Ctext">祥云客运站：9.15万元</p>
                                <p class="Ctext">宾川客运站：5.19万元</p>
                                <p class="Ctext">弥渡客运站：2.78万元</p>
                                <p class="Ctext">南涧客运站：3.40万元</p>
                                <p class="Ctext">巍山客运站：2.15万元</p>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- page__bd end -->
                <!-- page__bd start -->
                <div class="page__bd">
                    <div class="weui-cells__title"><label name="lbdate"></label></div>
                    <div class="weui-cells">
                        <div class="weui-cell">
                            <div class="weui-cell__bd">
                                <p>电子客票销售情况</p>
                            </div>
                            <div id="div_ettotal" class="weui-cell__ft">共计：94,354元</div>
                        </div>
                        <div class="weui-cell weui-cell_swiped">
                            <div id="words_et" class="page__bd">
                                <p class="Ctext" >东部客运站：微信销售：47张，共计：4,662元；自助设备销售：352张，共计：9,076元；其它网销渠道销售: 67张，共计：8,082元。</p>
                                <p class="Ctext" >快速客运站：微信销售: 89张,共计：5,241元；自助设备销售：162张，共计：8,671元；其它网销渠道销售：72张，共计：7,029元。</p>
                                <p class="Ctext" >兴盛客运站：微信销售:41张，共计:3,813元；自助设备销售: 628张,共计: 19,771元；其它网销渠道销售：80张，共计：9,460元。</p>
                                <p class="Ctext" >客运北站：微信销售：28张，共计：1,831元；自助设备销售：1张, 共计：56元；其它网销渠道销售：79张，共计：5,164元。</p>
                                <p class="Ctext" >县分公司：微信销售：57张，共计：4,951元；自助设备销售：13张,共计：1,289元；其它网销渠道销售：47张，共计：5,258元。</p>
								<p class="Ctext" >总计：车票1763张 保险255张 金额：94,354元</p>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- page__bd end -->
            </div>
            <!-- weui-tab__bd-item end -->

        </div>
    </div>
    <!-- tab选项卡 end -->
</block>
<block name="js">
<script type="text/javascript">
    var gqstations = [];//关区客运站
    var gqmoneys = [];//关区客运站客票统计
    var xfstations = [];//县分客运站
    var xfmoneys = [];//县分客运站客票统计
    var estation = [];//电子票统计客运站
    var echannel = [];//电子票统计渠道
    var ex_data_ticket = [];//电子数据
	var ex_data_money = [];//电子票金额
    //
    var surl = "{:U('Search')}";
    var iurl ="{:U('Index')}";
    var curl ="{:U('Contrast')}";
    //GetResult
    //查询参数获得
    var _Search_start = $.cookie('_Search_start');
    var _Search_end = $.cookie('_Search_end');
    var _Search_start_next = $.cookie('_Search_start_next');
    var _Search_end_next = $.cookie('_Search_end_next');
    var _Search_flag = $.cookie('_Search_flag');
	//查询参数初始化
	if(!_Search_flag)
       {
            _Search_flag=0;
       }
    if(!_Search_start)
       {
            var myDate = new Date();
            myDate.setTime(myDate.getTime()-30*24*60*60*1000);
            myDate = Date_Format(myDate,"yyyy-MM-dd");
            _Search_start = myDate;
            //
            var myDate1 = new Date();
            myDate1 = Date_Format(myDate1,"yyyy-MM-dd");
            _Search_end = myDate1;
      }
    if(_Search_start && !_Search_end)
    {
        _Search_end = _Search_start;
    }
    $(function(){
		//图表统计数据处理
		Charts_data_deal();
		$("#_data").click(function(){
			//数据按钮
			window.location.href = iurl;	
		});
		$("#_search").click(function(){
			//搜索按钮
			window.location.href = surl;	
		});
        $('.weui-tabbar__item').on('click', function () {
            $(this).addClass('weui-bar__item_on').siblings('.weui-bar__item_on').removeClass('weui-bar__item_on');
        });
        //weui-navbar

        $('#goToTop').click(function(){
            $('html , body').animate({scrollTop: 0},'slow');
        });
        htmlFontSize();
		Words_data_deal();
		
    });
	//图表部分数据处理Ajax
	function Charts_data_deal()
	{
		
        var lbtxt = _Search_start+"至"+_Search_end;
        $("label[name='lbdate']").each(function(){
            $(this).html(lbtxt);
        });
		var action_ = "{:U('GetResult')}";
        $.ajax({
            url:action_,
            type:"POST",
            data:{_Search_start:_Search_start,_Search_end:_Search_end
			,_Search_start_next:_Search_start_next,_Search_end_next:_Search_end_next
			,_Search_flag:_Search_flag},
            dataType:"json",
            error:function(data){
            },
            success:function(data){
                if(data)
                {
                    if(data.state == 0)
                    {
                        gqstations = data.GQstation;
                        gqmoneys = data.GQMmun;
                        xfstations = data.XFstation;
                        xfmoneys = data.XFMmun;
                        estation = data.Estation;
                        echannel = data.Echannel;
                        //图表部分
                        var ex_tcket = data.ex_data_ticket;
						var ex_mony = data.ex_data_money;
						var CK_WArray = data.CK_WArray;
						var e_total_html ='';
						//图表信息数据处理
                        for(var i=0;i < echannel.length ;i++)
                        {
                            var temp = {};
                            temp.name = echannel[i];
                            temp.type = "bar";
                            temp.label =  {
                                normal: {
                                    show: true,
                                    position: 'top'
                                }
                            };
							var temp0 = {};
                            temp0.name = echannel[i];
                            temp0.type = "bar";
                            temp0.label =  {
                                normal: {
                                    show: true,
                                    position: 'top'
                                }
                            };
                            var _dd = [];
							var _dd0 = [];
                            for(var j=0;j < ex_tcket.length ;j++)
                            {
                                //console.log(ex_tcket[j][1]);
                                if(echannel[i] == ex_tcket[j][1] )
                                {
                                    _dd = ex_tcket[j][3];
                                }
                            }
							for(var j=0;j < ex_mony.length ;j++)
                            {
                                //console.log(ex_tcket[j][1]);
                                if(echannel[i] == ex_mony[j][1] )
                                {
                                    _dd0 = ex_mony[j][3];
                                }
                            }
                            temp.data = _dd;
							temp0.data = _dd0;
                            ex_data_ticket.push(temp);
							ex_data_money.push(temp0);
                        }
						//
                        fun_charts();
                    }else {
                        $.alert("请您输入合适的查询条件进行检索！", "警告");
                    }
                }
            }
        });
	}
	//文字部分数据处理方法Ajax
	function Words_data_deal()
	{
		//文字信息统计处理
		var action_ = "{:U('GetResultWords')}";
		$("#words_select").click(function(){
			$.ajax({
				url:action_,
				type:"POST",
				data:{_Search_start:_Search_start,_Search_end:_Search_end
				,_Search_start_next:_Search_start_next,_Search_end_next:_Search_end_next
				,_Search_flag:_Search_flag},
				dataType:"json",
				error:function(data){
				},
				success:function(data){
					if(data)
					{
						if(data.state == 0)
						{
							var ck_data_w = data.CK_WArray;
							var et_data_w = data.words_data;
							var total_ = data.total_data[0];
							if(total_){
									
									//综合统计
									var _html ='';
									_html += '<h3>综合预览</h3>';
									_html += '<p class="Ctext">窗口票销售情况：'+total_.total_ck_t+' 张，共计：'+total_.total_ck_m+' 万元;</p>';
									_html += '<p class="Ctext">电子票销售情况：'+total_.etotal_t+' 张，共计：'+total_.etotal_m+' 元;</p>';
									_html += '<p class="Ctext">保险票销售情况：'+total_.total_i+' 张 ;</p>';
									$("#div_wtotal").html(_html);
									//									
									$("#div_cktotal").html("总计："+total_.total_ck_m+" 万元");
									$("#div_ettotal").html("总计："+total_.etotal_m+" 元");
								}
							if(ck_data_w)
							{
								//窗口售票统计-文字
								var ck_html ="";
								for(var i=0;i < ck_data_w.length ;i++)
								{
									ck_html +='<p class="Ctext">'+ck_data_w[i]["stationname"]+'：'+ck_data_w[i]["money"]+'万元</p>';
								}
								$("#words_ck").html(ck_html);
							}
							if(et_data_w)
							{
								var _html ='';
								for(var i=0;i < et_data_w.length ;i++)
								{
									_html += '<p class="Ctext">'+et_data_w[i][1]+'：'
									+et_data_w[i][2]+et_data_w[i][3]
									+et_data_w[i][4]+et_data_w[i][5]+' 元'
									+'；'+et_data_w[i][6]+et_data_w[i][7]
									+et_data_w[i][8]+et_data_w[i][9]+' 元'
									+'；'+et_data_w[i][10]+et_data_w[i][11]
									+et_data_w[i][12]+et_data_w[i][13]+' 元'
									+'</p>';
								}
								if(total_){
									_html += '<p class="Ctext">总计：车票 '+total_.etotal_t+' 张，保险'
									+total_.total_i+' 张 ，共计：'+total_.etotal_m+' 元;</p>';
								}
								$("#words_et").html(_html);
							}
							
						}else {
							$.alert("请您输入合适的查询条件进行检索！", "警告");
						}
					}
				}
			});
		});
	}
    //图标渲染处理逻辑
    function fun_charts(){
        //
        var worldMapContainer = document.getElementById('myChart1');

        //用于使chart自适应高度和宽度,通过窗体高宽计算容器高宽
        var resizeWorldMapContainer = function () {
            worldMapContainer.style.width = window.innerWidth+'px';
            worldMapContainer.style.height = window.innerHeight+'px';
        };
        //设置容器高宽
        resizeWorldMapContainer();
        var myChart_ = echarts.init(worldMapContainer);
        // 指定图表的配置项和数据
        var option = {
            title: {
                text: '窗口售票金额'
            },
            grid: {
                y2: 40
            },
            tooltip: {},
            color: ['rgb(25, 183, 207)'],
            legend: {
                data:['单位：万元']
            },
            itemStyle:{
                normal:{
                    //每个柱子的颜色即为colorList数组里的每一项，如果柱子数目多于colorList的长度，则柱子颜色循环使用该数组
                    color: function (params){
                        var colorList = ['rgb(164,205,238)','rgb(42,170,227)','rgb(25,46,94)','rgb(195,229,235)'];
                        return colorList[params.dataIndex];
                    }
                },

            },
            xAxis: {
                data: gqstations,
                axisLabel:{
                    interval:0,//横轴信息全部显示
                    rotate:30,//-30度角倾斜显示
                }
            },
            yAxis: {},
            series: [{
                name: '单位：万元',
                type: 'bar',
                label: {
                    normal: {
                        show: true,
                        position: 'top'
                    }
                },
                data: gqmoneys,

            }]
        };
        // 使用刚指定的配置项和数据显示图表。
        myChart_.setOption(option);
        //用于使chart自适应高度和宽度
        //
        var worldMapContainer2 = document.getElementById('myChart2');

        //用于使chart自适应高度和宽度,通过窗体高宽计算容器高宽
        var resizeWorldMapContainer2 = function () {
            worldMapContainer2.style.width = window.innerWidth+'px';
            worldMapContainer2.style.height = window.innerHeight+'px';
        };
        //设置容器高宽
        resizeWorldMapContainer2();
        var myChart_2 = echarts.init(worldMapContainer2);
        // 指定图表的配置项和数据
        var option2 = {
            title: {
                text: '窗口售票金额'
            },
            grid: {
                y2: 60
            },
            tooltip: {},
            legend: {
                data:['单位：万元']
            },
            color: ['rgb(25, 183, 207)'],
            xAxis: {
				data: xfstations
                ,
                axisLabel:{
                    interval:0,//横轴信息全部显示
                    rotate:30,//60度角倾斜显示
                }
            },
            yAxis: {
                
            },
            series: [{
                name: '单位：万元',
                type: 'bar',
                label: {
                    normal: {
                        show: true,
                        position: 'top'
                    }
                },
                data: xfmoneys
            }]
        };
        // 使用刚指定的配置项和数据显示图表。
        myChart_2.setOption(option2);
        //
        var worldMapContainer3 = document.getElementById('myChart3');

        //用于使chart自适应高度和宽度,通过窗体高宽计算容器高宽
        var resizeWorldMapContainer3 = function () {
            worldMapContainer3.style.width = window.innerWidth+'px';
            worldMapContainer3.style.height = window.innerHeight+'px';
        };
        //设置容器高宽
        resizeWorldMapContainer3();
        //
        var myChart_3 = echarts.init(worldMapContainer3);
        // 指定图表的配置项和数据
        var option3 = {
            tooltip : {
                trigger: 'axis',
                axisPointer : {            // 坐标轴指示器，坐标轴触发有效
                    type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
                }
            },
            legend: {
                data:echannel
            },
            xAxis : [
                {
                    type : 'category',
                    data : estation,
                    axisLabel:{
                        interval:0,//横轴信息全部显示
                        rotate:30,//60度角倾斜显示
                    }
                }
            ],
            yAxis : [
                {
                    type : 'value'
                }
            ],
            series : ex_data_ticket
        };
        // 使用刚指定的配置项和数据显示图表。
        myChart_3.setOption(option3);
        //
        var worldMapContainer4 = document.getElementById('myChart4');

        //用于使chart自适应高度和宽度,通过窗体高宽计算容器高宽
        var resizeWorldMapContainer4 = function () {
            worldMapContainer4.style.width = window.innerWidth+'px';
            worldMapContainer4.style.height = window.innerHeight+'px';
        };
        //设置容器高宽
        resizeWorldMapContainer4();
        var myChart_4 = echarts.init(worldMapContainer4);
        // 指定图表的配置项和数据
        var option4 = {
            tooltip : {
                trigger: 'axis',
                axisPointer : {            // 坐标轴指示器，坐标轴触发有效
                    type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
                }
            },
            legend: {
                data:echannel
            },
            xAxis : [
                {
                    type : 'category',
                    data : estation,
					 axisLabel:{
                        interval:0,//横轴信息全部显示
                        rotate:30,//60度角倾斜显示
                    }
                }
            ],
            yAxis : [
                {
                    type : 'value'
                }
            ],
            series : ex_data_money
        };
        // 使用刚指定的配置项和数据显示图表。
        myChart_4.setOption(option4);
        //
        window.onresize = function () {
            //重置容器高宽

            resizeWorldMapContainer();
            myChart_.resize();
            resizeWorldMapContainer2();
            myChart_2.resize();
            resizeWorldMapContainer3();
            myChart_3.resize();
            resizeWorldMapContainer4();
            myChart_4.resize();
        };
    }
</script>
</block>